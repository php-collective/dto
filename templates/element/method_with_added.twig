{% if collection %}
	/**
{% if deprecated is not null %}
	 * @deprecated {{ deprecated }}
	 *
{% endif %}
{% if associative %}
	 * @param {{ keyType }} $key
{% endif %}
	 * @param {{ singularType }}{% if singularNullable %}|null{% endif %} ${{ singular }}
	 *
	 * @return static
	 */
	public function withAdded{{ singular|stripLeadingUnderscore|camelize }}({% if associative %}$key, {% endif %}{% if singularTypeHint %}{% if singularNullable %}?{% endif %}{{ singularTypeHint }} {% endif %}${{ singular }})
	{
{% if readonlyProperties|default(false) %}
		$data = $this->toArray();
		if (!isset($data['{{ name }}'])) {
			$data['{{ name }}'] = [];
		}
{% if associative %}
		$data['{{ name }}'][$key] = ${{ singular }};
{% else %}
		$data['{{ name }}'][] = ${{ singular }};
{% endif %}

		return new static($data);
{% else %}
		$new = clone $this;

		if ($new->{{ name }} === null) {
			$new->{{ name }} = {% if collectionType == 'array' %}[]{% else %}new {{ typeHint }}([]){% endif %};
		}{% if collectionType != 'array' %} else {
			$new->{{ name }} = clone $new->{{ name }};
		}{% endif %}

{% if associative %}
		$new->{{ name }}[$key] = ${{ singular }};
{% else %}
		$new->{{ name }}[] = ${{ singular }};
{% endif %}
		$new->_touchedFields[static::FIELD_{{ name | stripLeadingUnderscore | camelize | underscore | upper }}] = true;

		return $new;
{% endif %}
	}
{% endif -%}
