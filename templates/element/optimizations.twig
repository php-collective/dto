	/**
	 * Whether this DTO is immutable.
	 *
	 * @var bool
	 */
	protected const IS_IMMUTABLE = {{ immutable ? 'true' : 'false' }};

	/**
	 * Whether this DTO has generated fast-path methods.
	 *
	 * @var bool
	 */
	protected const HAS_FAST_PATH = true;

	/**
	 * Pre-computed setter method names for fast lookup.
	 *
	 * @var array<string, string>
	 */
	protected static array $_setters = [
{% for field in fields %}
		'{{ field.name }}' => '{% if immutable %}with{% else %}set{% endif %}{{ field.name | stripLeadingUnderscore | camelize }}',
{% endfor %}
	];

	/**
	 * Optimized array assignment without dynamic method calls.
	 *
	 * @param array<string, mixed> $data
	 *
	 * @return void
	 */
	protected function setFromArrayFast(array $data): void
	{
{% for field in fields %}
{% if field.dto %}
		if (isset($data['{{ field.name }}'])) {
			$value = $data['{{ field.name }}'];
			if (is_array($value)) {
				$value = new {{ field.typeHint }}($value);
			}
			/** @var {{ field.nullableTypeHint ?? field.typeHint }} $value */
			$this->{{ field.name }} = $value;
			$this->_touchedFields['{{ field.name }}'] = true;
		}
{% elseif field.collection and field.collectionType != 'array' %}
		if (isset($data['{{ field.name }}'])) {
			$collection = new {{ field.collectionType }}();
			/** @var array $items */
			$items = $data['{{ field.name }}'];
			foreach ($items as $item) {
{% if field.singularClass is defined and field.singularClass %}
				if (is_array($item)) {
					$item = new {{ field.singularClass }}($item);
				}
{% endif %}
				$collection->append($item);
			}
			$this->{{ field.name }} = $collection;
			$this->_touchedFields['{{ field.name }}'] = true;
		}
{% elseif field.collection and field.collectionType == 'array' and field.singularClass is defined and field.singularClass %}
		if (isset($data['{{ field.name }}'])) {
			$collection = [];
			/** @var array $items */
			$items = $data['{{ field.name }}'];
			foreach ($items as $key => $item) {
				if (is_array($item)) {
					$item = new {{ field.singularClass }}($item);
				}
				$collection[$key] = $item;
			}
			$this->{{ field.name }} = $collection;
			$this->_touchedFields['{{ field.name }}'] = true;
		}
{% elseif field.enum and field.isClass %}
		if (isset($data['{{ field.name }}'])) {
			$value = $data['{{ field.name }}'];
			if (!$value instanceof \UnitEnum) {
{% if field.enum == 'unit' %}
				$value = constant({{ field.typeHint }}::class . "::{$value}");
{% else %}
				$value = {{ field.typeHint }}::tryFrom($value);
{% endif %}
			}
			$this->{{ field.name }} = $value;
			$this->_touchedFields['{{ field.name }}'] = true;
		}
{% elseif field.factory and field.isClass %}
		if (isset($data['{{ field.name }}'])) {
			$value = $data['{{ field.name }}'];
			if (!$value instanceof {{ field.typeHint }}) {
{% if '::' in field.factory %}
{% set factoryParts = field.factory | split('::') %}
				$value = {{ factoryParts[0] }}::{{ factoryParts[1] }}($value);
{% else %}
				$value = {{ field.typeHint }}::{{ field.factory }}($value);
{% endif %}
			}
			$this->{{ field.name }} = $value;
			$this->_touchedFields['{{ field.name }}'] = true;
		}
{% elseif field.isClass %}
		if (isset($data['{{ field.name }}'])) {
			$value = $data['{{ field.name }}'];
			if (!$value instanceof {{ field.typeHint }}) {
				$value = new {{ field.typeHint }}($value);
			}
			$this->{{ field.name }} = $value;
			$this->_touchedFields['{{ field.name }}'] = true;
		}
{% else %}
		if (isset($data['{{ field.name }}'])) {
			/** @var {{ field.docBlockType ?? field.typeHint }}{% if field.nullable %}|null{% endif %} $value */
			$value = $data['{{ field.name }}'];
			$this->{{ field.name }} = $value;
			$this->_touchedFields['{{ field.name }}'] = true;
		}
{% endif %}
{% endfor %}
	}

	/**
	 * Optimized toArray for default type without dynamic dispatch.
	 *
	 * @return array<string, mixed>
	 */
	protected function toArrayFast(): array
	{
		return [
{% for field in fields %}
{% set key = field.mapTo is not null ? field.mapTo : field.name %}
{% if field.dto %}
{% if field.nullable %}
			'{{ key }}' => $this->{{ field.name }} !== null ? $this->{{ field.name }}->toArray() : null,
{% else %}
			'{{ key }}' => $this->{{ field.name }}->toArray(),
{% endif %}
{% elseif field.collection and field.collectionType != 'array' %}
			'{{ key }}' => $this->{{ field.name }} !== null ? (static function (\Traversable $c): array {
				$r = [];
				foreach ($c as $k => $v) {
{% if field.singularClass is defined and field.singularClass %}
					$r[$k] = $v->toArray();
{% else %}
					$r[$k] = is_object($v) && $v instanceof \PhpCollective\Dto\Dto\Dto ? $v->toArray() : $v;
{% endif %}
				}

				return $r;
			})($this->{{ field.name }}) : [],
{% elseif field.collection and field.collectionType == 'array' and field.singularClass is defined and field.singularClass %}
{% if field.nullable %}
			'{{ key }}' => (static function (?array $a): array {
				if (!$a) {
					return [];
				}
				$r = [];
				foreach ($a as $k => $v) {
					$r[$k] = $v->toArray();
				}

				return $r;
			})($this->{{ field.name }}),
{% else %}
			'{{ key }}' => (static function (array $a): array {
				$r = [];
				foreach ($a as $k => $v) {
					$r[$k] = $v->toArray();
				}

				return $r;
			})($this->{{ field.name }}),
{% endif %}
{% elseif field.enum and field.isClass %}
{% if field.nullable %}
{% if field.enum == 'unit' %}
			'{{ key }}' => $this->{{ field.name }}?->name,
{% else %}
			'{{ key }}' => $this->{{ field.name }}?->value,
{% endif %}
{% else %}
{% if field.enum == 'unit' %}
			'{{ key }}' => $this->{{ field.name }}->name,
{% else %}
			'{{ key }}' => $this->{{ field.name }}->value,
{% endif %}
{% endif %}
{% elseif field.isClass and field.serialize == 'string' %}
{% if field.nullable %}
			'{{ key }}' => $this->{{ field.name }} !== null ? (string)$this->{{ field.name }} : null,
{% else %}
			'{{ key }}' => (string)$this->{{ field.name }},
{% endif %}
{% elseif field.isClass and (field.serialize == 'array' or field.serialize == 'FromArrayToArray') %}
{% if field.nullable %}
			'{{ key }}' => $this->{{ field.name }} !== null ? $this->{{ field.name }}->toArray() : null,
{% else %}
			'{{ key }}' => $this->{{ field.name }}->toArray(),
{% endif %}
{% else %}
			'{{ key }}' => $this->{{ field.name }},
{% endif %}
{% endfor %}
		];
	}
{% set fieldsWithDefaults = [] %}
{% for field in fields %}
{% if field.defaultValue is not null %}
{% set fieldsWithDefaults = fieldsWithDefaults | merge([field]) %}
{% endif %}
{% endfor %}

	/**
	 * Optimized setDefaults - only processes fields with default values.
	 *
	 * @return $this
	 */
	protected function setDefaults()
	{
{% if fieldsWithDefaults | length > 0 %}
{% for field in fieldsWithDefaults %}
{% if field.nullable %}
		if ($this->{{ field.name }} === null) {
{% else %}
		if (!isset($this->{{ field.name }})) {
{% endif %}
			$this->{{ field.name }} = {{ field.defaultValue | phpExport | raw }};
		}
{% endfor %}

{% endif %}
		return $this;
	}
{% set requiredFields = [] %}
{% for field in fields %}
{% if field.required %}
{% set requiredFields = requiredFields | merge([field]) %}
{% endif %}
{% endfor %}

	/**
	 * Optimized validate - only checks required fields.
	 *
	 * @throws \InvalidArgumentException
	 *
	 * @return void
	 */
	protected function validate(): void
	{
{% if requiredFields | length > 0 %}
{% set checks = [] %}
{% for field in requiredFields %}
{% if field.nullable %}
{% set checks = checks | merge(['$this->' ~ field.name ~ ' === null']) %}
{% else %}
{% set checks = checks | merge(['!isset($this->' ~ field.name ~ ')']) %}
{% endif %}
{% endfor %}
		if ({{ checks | join(' || ') }}) {
			$errors = [];
{% for field in requiredFields %}
{% if field.nullable %}
			if ($this->{{ field.name }} === null) {
{% else %}
			if (!isset($this->{{ field.name }})) {
{% endif %}
				$errors[] = '{{ field.name }}';
			}
{% endfor %}
			if ($errors) {
				throw new InvalidArgumentException('Required fields missing: ' . implode(', ', $errors));
			}
		}
{% endif %}
	}

