	/**
	 * Whether this DTO is immutable.
	 *
	 * @var bool
	 */
	protected const IS_IMMUTABLE = {{ immutable ? 'true' : 'false' }};

	/**
	 * Whether this DTO has generated fast-path methods.
	 *
	 * @var bool
	 */
	protected const HAS_FAST_PATH = true;

	/**
	 * Optimized array assignment without dynamic method calls.
	 *
	 * @param array<string, mixed> $data
	 *
	 * @return void
	 */
	protected function setFromArrayFast(array $data): void
	{
{% for field in fields %}
{% if field.lazy|default(false) %}
		if (isset($data['{{ field.name }}'])) {
{% if field.transformFrom %}
			$this->_lazyData['{{ field.name }}'] = $this->transformValue('{{ field.transformFrom }}', $data['{{ field.name }}']);
{% else %}
			$this->_lazyData['{{ field.name }}'] = $data['{{ field.name }}'];
{% endif %}
			$this->_touchedFields['{{ field.name }}'] = true;
		}
{% elseif field.dto %}
		if (isset($data['{{ field.name }}'])) {
			$value = $data['{{ field.name }}'];
{% if field.transformFrom %}
			$value = $this->transformValue('{{ field.transformFrom }}', $value);
{% endif %}
			if (is_array($value)) {
				$value = new {{ field.typeHint }}($value);
			}
			/** @var {{ field.nullableTypeHint ?? field.typeHint }} $value */
			$this->{{ field.name }} = $value;
			$this->_touchedFields['{{ field.name }}'] = true;
		}
{% elseif field.collection and field.collectionType != 'array' %}
{% set adapter = getCollectionAdapter(field.collectionType) %}
		if (isset($data['{{ field.name }}'])) {
			$collection = {{ adapter.getCreateEmptyCode(field.collectionType) }};
			/** @var array $items */
			$items = $data['{{ field.name }}'];
			foreach ($items as $key => $item) {
{% if field.transformFrom %}
				$item = $this->transformValue('{{ field.transformFrom }}', $item);
{% endif %}
{% if field.singularClass is defined and field.singularClass %}
				if (is_array($item)) {
					$item = new {{ field.singularClass }}($item);
				}
{% endif %}
{% if field.associative and field.key %}
				if (is_array($data['{{ field.name }}'][$key]) && isset($data['{{ field.name }}'][$key]['{{ field.key }}'])) {
					$key = $data['{{ field.name }}'][$key]['{{ field.key }}'];
				}
				$collection[$key] = $item;
{% elseif field.associative %}
				$collection[$key] = $item;
{% else %}
				{{ adapter.getAppendCode('$collection', '$item') }}
{% endif %}
			}
			$this->{{ field.name }} = $collection;
			$this->_touchedFields['{{ field.name }}'] = true;
		}
{% elseif field.collection and field.collectionType == 'array' and field.singularClass is defined and field.singularClass %}
		if (isset($data['{{ field.name }}'])) {
			$collection = [];
			/** @var array $items */
			$items = $data['{{ field.name }}'];
			foreach ($items as $key => $item) {
{% if field.transformFrom %}
				$item = $this->transformValue('{{ field.transformFrom }}', $item);
{% endif %}
				if (is_array($item)) {
					$item = new {{ field.singularClass }}($item);
				}
				$collection[$key] = $item;
			}
			$this->{{ field.name }} = $collection;
			$this->_touchedFields['{{ field.name }}'] = true;
		}
{% elseif field.enum and field.isClass %}
		if (isset($data['{{ field.name }}'])) {
			$value = $data['{{ field.name }}'];
{% if field.transformFrom %}
			$value = $this->transformValue('{{ field.transformFrom }}', $value);
{% endif %}
			if (!$value instanceof \UnitEnum) {
{% if field.enum == 'unit' %}
				$value = constant({{ field.typeHint }}::class . "::{$value}");
{% else %}
				$value = {{ field.typeHint }}::tryFrom($value);
{% endif %}
			}
			$this->{{ field.name }} = $value;
			$this->_touchedFields['{{ field.name }}'] = true;
		}
{% elseif field.factory and field.isClass %}
		if (isset($data['{{ field.name }}'])) {
			$value = $data['{{ field.name }}'];
{% if field.transformFrom %}
			$value = $this->transformValue('{{ field.transformFrom }}', $value);
{% endif %}
			if (!$value instanceof {{ field.typeHint }}) {
{% if '::' in field.factory %}
{% set factoryParts = field.factory | split('::') %}
				$value = {{ factoryParts[0] }}::{{ factoryParts[1] }}($value);
{% else %}
				$value = {{ field.typeHint }}::{{ field.factory }}($value);
{% endif %}
			}
			$this->{{ field.name }} = $value;
			$this->_touchedFields['{{ field.name }}'] = true;
		}
{% elseif field.isClass %}
		if (isset($data['{{ field.name }}'])) {
			$value = $data['{{ field.name }}'];
{% if field.transformFrom %}
			$value = $this->transformValue('{{ field.transformFrom }}', $value);
{% endif %}
			if (!$value instanceof {{ field.typeHint }}) {
				$value = new {{ field.typeHint }}($value);
			}
			$this->{{ field.name }} = $value;
			$this->_touchedFields['{{ field.name }}'] = true;
		}
{% else %}
		if (isset($data['{{ field.name }}'])) {
			/** @var {{ field.docBlockType ?? field.typeHint }}{% if field.nullable %}|null{% endif %} $value */
			$value = $data['{{ field.name }}'];
{% if field.transformFrom %}
			$value = $this->transformValue('{{ field.transformFrom }}', $value);
{% endif %}
			$this->{{ field.name }} = $value;
			$this->_touchedFields['{{ field.name }}'] = true;
		}
{% endif %}
{% endfor %}
	}

	/**
	 * Optimized toArray for default type without dynamic dispatch.
	 *
	 * @return array<string, mixed>
	 */
	protected function toArrayFast(): array
	{
		return [
{% for field in fields %}
{% set key = field.mapTo is not null ? field.mapTo : field.name %}
{% if field.lazy|default(false) %}
{% if field.transformTo %}
			'{{ key }}' => $this->transformValue('{{ field.transformTo }}', $this->_lazyData['{{ field.name }}'] ?? ($this->{{ field.name }} !== null ? {% if field.dto %}$this->{{ field.name }}->toArray(){% elseif field.collection and field.collectionType != 'array' %}(static function (\Traversable $c): array { $r = []; foreach ($c as $k => $v) { $r[$k] = is_object($v) && $v instanceof \PhpCollective\Dto\Dto\Dto ? $v->toArray() : $v; } return $r; })($this->{{ field.name }}){% else %}$this->{{ field.name }}{% endif %} : null)),
{% else %}
			'{{ key }}' => $this->_lazyData['{{ field.name }}'] ?? ($this->{{ field.name }} !== null ? {% if field.dto %}$this->{{ field.name }}->toArray(){% elseif field.collection and field.collectionType != 'array' %}(static function (\Traversable $c): array { $r = []; foreach ($c as $k => $v) { $r[$k] = is_object($v) && $v instanceof \PhpCollective\Dto\Dto\Dto ? $v->toArray() : $v; } return $r; })($this->{{ field.name }}){% else %}$this->{{ field.name }}{% endif %} : null),
{% endif %}
{% elseif field.dto %}
{% if field.nullable %}
{% if field.transformTo %}
			'{{ key }}' => $this->transformValue('{{ field.transformTo }}', $this->{{ field.name }} !== null ? $this->{{ field.name }}->toArray() : null),
{% else %}
			'{{ key }}' => $this->{{ field.name }} !== null ? $this->{{ field.name }}->toArray() : null,
{% endif %}
{% else %}
{% if field.transformTo %}
			'{{ key }}' => $this->transformValue('{{ field.transformTo }}', $this->{{ field.name }}->toArray()),
{% else %}
			'{{ key }}' => $this->{{ field.name }}->toArray(),
{% endif %}
{% endif %}
{% elseif field.collection and field.collectionType != 'array' %}
{% if field.transformTo %}
			'{{ key }}' => $this->transformArrayValues('{{ field.transformTo }}', $this->{{ field.name }} !== null ? (static function (\Traversable $c): array {
				$r = [];
				foreach ($c as $k => $v) {
{% if field.singularClass is defined and field.singularClass %}
					$r[$k] = $v->toArray();
{% else %}
					$r[$k] = is_object($v) && $v instanceof \PhpCollective\Dto\Dto\Dto ? $v->toArray() : $v;
{% endif %}
				}

				return $r;
			})($this->{{ field.name }}) : []),
{% else %}
			'{{ key }}' => $this->{{ field.name }} !== null ? (static function (\Traversable $c): array {
				$r = [];
				foreach ($c as $k => $v) {
{% if field.singularClass is defined and field.singularClass %}
					$r[$k] = $v->toArray();
{% else %}
					$r[$k] = is_object($v) && $v instanceof \PhpCollective\Dto\Dto\Dto ? $v->toArray() : $v;
{% endif %}
				}

				return $r;
			})($this->{{ field.name }}) : [],
{% endif %}
{% elseif field.collection and field.collectionType == 'array' and field.singularClass is defined and field.singularClass %}
{% if field.nullable %}
{% if field.transformTo %}
			'{{ key }}' => $this->transformArrayValues('{{ field.transformTo }}', (static function (?array $a): array {
				if (!$a) {
					return [];
				}
				$r = [];
				foreach ($a as $k => $v) {
					$r[$k] = $v->toArray();
				}

				return $r;
			})($this->{{ field.name }})),
{% else %}
			'{{ key }}' => (static function (?array $a): array {
				if (!$a) {
					return [];
				}
				$r = [];
				foreach ($a as $k => $v) {
					$r[$k] = $v->toArray();
				}

				return $r;
			})($this->{{ field.name }}),
{% endif %}
{% else %}
{% if field.transformTo %}
			'{{ key }}' => $this->transformArrayValues('{{ field.transformTo }}', (static function (array $a): array {
				$r = [];
				foreach ($a as $k => $v) {
					$r[$k] = $v->toArray();
				}

				return $r;
			})($this->{{ field.name }})),
{% else %}
			'{{ key }}' => (static function (array $a): array {
				$r = [];
				foreach ($a as $k => $v) {
					$r[$k] = $v->toArray();
				}

				return $r;
			})($this->{{ field.name }}),
{% endif %}
{% endif %}
{% elseif field.enum and field.isClass %}
{% if field.nullable %}
{% if field.enum == 'unit' %}
{% if field.transformTo %}
			'{{ key }}' => $this->transformValue('{{ field.transformTo }}', $this->{{ field.name }}?->name),
{% else %}
			'{{ key }}' => $this->{{ field.name }}?->name,
{% endif %}
{% else %}
{% if field.transformTo %}
			'{{ key }}' => $this->transformValue('{{ field.transformTo }}', $this->{{ field.name }}?->value),
{% else %}
			'{{ key }}' => $this->{{ field.name }}?->value,
{% endif %}
{% endif %}
{% else %}
{% if field.enum == 'unit' %}
{% if field.transformTo %}
			'{{ key }}' => $this->transformValue('{{ field.transformTo }}', $this->{{ field.name }}->name),
{% else %}
			'{{ key }}' => $this->{{ field.name }}->name,
{% endif %}
{% else %}
{% if field.transformTo %}
			'{{ key }}' => $this->transformValue('{{ field.transformTo }}', $this->{{ field.name }}->value),
{% else %}
			'{{ key }}' => $this->{{ field.name }}->value,
{% endif %}
{% endif %}
{% endif %}
{% elseif field.isClass and field.serialize == 'string' %}
{% if field.nullable %}
{% if field.transformTo %}
			'{{ key }}' => $this->transformValue('{{ field.transformTo }}', $this->{{ field.name }} !== null ? (string)$this->{{ field.name }} : null),
{% else %}
			'{{ key }}' => $this->{{ field.name }} !== null ? (string)$this->{{ field.name }} : null,
{% endif %}
{% else %}
{% if field.transformTo %}
			'{{ key }}' => $this->transformValue('{{ field.transformTo }}', (string)$this->{{ field.name }}),
{% else %}
			'{{ key }}' => (string)$this->{{ field.name }},
{% endif %}
{% endif %}
{% elseif field.isClass and (field.serialize == 'array' or field.serialize == 'FromArrayToArray') %}
{% if field.nullable %}
{% if field.transformTo %}
			'{{ key }}' => $this->transformValue('{{ field.transformTo }}', $this->{{ field.name }} !== null ? $this->{{ field.name }}->toArray() : null),
{% else %}
			'{{ key }}' => $this->{{ field.name }} !== null ? $this->{{ field.name }}->toArray() : null,
{% endif %}
{% else %}
{% if field.transformTo %}
			'{{ key }}' => $this->transformValue('{{ field.transformTo }}', $this->{{ field.name }}->toArray()),
{% else %}
			'{{ key }}' => $this->{{ field.name }}->toArray(),
{% endif %}
{% endif %}
{% else %}
{% if field.transformTo %}
			'{{ key }}' => $this->transformValue('{{ field.transformTo }}', $this->{{ field.name }}),
{% else %}
			'{{ key }}' => $this->{{ field.name }},
{% endif %}
{% endif %}
{% endfor %}
		];
	}
{% set fieldsWithDefaults = [] %}
{% set uninitializedNullableFields = [] %}
{% for field in fields %}
{% if field.defaultValue is not null %}
{% set fieldsWithDefaults = fieldsWithDefaults | merge([field]) %}
{% endif %}
{% if readonlyProperties|default(false) and field.nullable and field.defaultValue is null %}
{% set uninitializedNullableFields = uninitializedNullableFields | merge([field]) %}
{% endif %}
{% endfor %}

	/**
	 * Optimized setDefaults - only processes fields with default values.
	 *
	 * @return $this
	 */
	protected function setDefaults()
	{
{% if readonlyProperties|default(false) and uninitializedNullableFields | length > 0 %}
{% for field in uninitializedNullableFields %}
		if (!isset($this->{{ field.name }})) {
			$this->{{ field.name }} = null;
		}
{% endfor %}
{% endif %}
{% if fieldsWithDefaults | length > 0 %}
{% for field in fieldsWithDefaults %}
{% if field.nullable %}
		if ($this->{{ field.name }} === null) {
{% else %}
		if (!isset($this->{{ field.name }})) {
{% endif %}
			$this->{{ field.name }} = {{ field.defaultValue | phpExport | raw }};
		}
{% endfor %}

{% endif %}
		return $this;
	}
{% set requiredFields = [] %}
{% set validatedFields = [] %}
{% for field in fields %}
{% if field.required %}
{% set requiredFields = requiredFields | merge([field]) %}
{% endif %}
{% if field.minLength is not null or field.maxLength is not null or field.min is not null or field.max is not null or field.pattern is not null %}
{% set validatedFields = validatedFields | merge([field]) %}
{% endif %}
{% endfor %}

	/**
	 * Optimized validate - checks required fields and validation rules.
	 *
	 * @throws \InvalidArgumentException
	 *
	 * @return void
	 */
	protected function validate(): void
	{
{% if requiredFields | length > 0 %}
{% set checks = [] %}
{% for field in requiredFields %}
{% if field.nullable %}
{% set checks = checks | merge(['$this->' ~ field.name ~ ' === null']) %}
{% else %}
{% set checks = checks | merge(['!isset($this->' ~ field.name ~ ')']) %}
{% endif %}
{% endfor %}
		if ({{ checks | join(' || ') }}) {
			$errors = [];
{% for field in requiredFields %}
{% if field.nullable %}
			if ($this->{{ field.name }} === null) {
{% else %}
			if (!isset($this->{{ field.name }})) {
{% endif %}
				$errors[] = '{{ field.name }}';
			}
{% endfor %}
			if ($errors) {
				throw new InvalidArgumentException('Required fields missing: ' . implode(', ', $errors));
			}
		}
{% endif %}
{% if validatedFields | length > 0 %}

		$errors = [];
{% for field in validatedFields %}
		if ($this->{{ field.name }} !== null) {
{% if field.minLength is not null %}
			if (is_string($this->{{ field.name }}) && mb_strlen($this->{{ field.name }}) < {{ field.minLength }}) {
				$errors[] = '{{ field.name }} must be at least {{ field.minLength }} characters';
			}
{% endif %}
{% if field.maxLength is not null %}
			if (is_string($this->{{ field.name }}) && mb_strlen($this->{{ field.name }}) > {{ field.maxLength }}) {
				$errors[] = '{{ field.name }} must be at most {{ field.maxLength }} characters';
			}
{% endif %}
{% if field.min is not null %}
			if (is_numeric($this->{{ field.name }}) && $this->{{ field.name }} < {{ field.min }}) {
				$errors[] = '{{ field.name }} must be at least {{ field.min }}';
			}
{% endif %}
{% if field.max is not null %}
			if (is_numeric($this->{{ field.name }}) && $this->{{ field.name }} > {{ field.max }}) {
				$errors[] = '{{ field.name }} must be at most {{ field.max }}';
			}
{% endif %}
{% if field.pattern is not null %}
			if (is_string($this->{{ field.name }}) && !preg_match('{{ field.pattern | e('html') }}', $this->{{ field.name }})) {
				$errors[] = '{{ field.name }} must match pattern {{ field.pattern | e('html') }}';
			}
{% endif %}
		}
{% endfor %}
		if ($errors) {
			throw new InvalidArgumentException('Validation failed: ' . implode(', ', $errors));
		}
{% endif %}
	}
